<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>人生ゲーム 改良版</title>
  <style>
    :root{
      --board-cols:8; --board-rows:5; --cell-size:68px;
      --accent:#ff6b6b; --bg:#fffaf0; --text:#222; --active:#4c9aff;
      --ok:#00c853; --warn:#ff8f00; --bad:#e53935; --muted:#94a3b8;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic","Meiryo",sans-serif; color:var(--text); background:var(--bg); display:flex; flex-direction:column; align-items:center}

    /* ===== App Bar / Toolbar ===== */
    .appbar{position:sticky; top:0; z-index:10; width:100%; display:flex; justify-content:center; background:linear-gradient(180deg, rgba(255,250,240,.95), rgba(255,250,240,.85)); backdrop-filter:saturate(1.2) blur(2px); border-bottom:1px solid #eee}
    .toolbar{width:min(1100px,100%); padding:12px 16px; display:flex; flex-wrap:wrap; align-items:center; gap:10px}
    .title{font-weight:800; font-size:16px; color:#111; letter-spacing:.02em; white-space:nowrap; margin-right:auto}

    .group{display:flex; align-items:center; gap:6px; padding:6px 8px; background:#fff; border:1px solid #e6e8eb; border-radius:10px}
    label{font-size:12px; color:#555}
    select,input[type="number"],input[type="text"],input[type="range"]{padding:6px 8px; border-radius:8px; border:1px solid #ddd}
    input[type="range"]{width:140px}
    button{padding:10px 14px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; font-weight:600}
    button.primary{background:var(--accent); color:#fff; border-color:transparent}
    button:disabled{opacity:.5; cursor:not-allowed}
    .dice{width:42px; height:42px; display:grid; place-items:center; border-radius:8px; border:1px solid #e2e8f0; background:#fff; font-weight:800}
    .dice.spin{animation:spin .6s ease}
    @keyframes spin{0%{transform:rotate(0)}50%{transform:rotate(180deg) scale(1.15)}100%{transform:rotate(360deg)}}

    /* ===== Layout ===== */
    .wrap{width:min(1100px,100%); padding:16px; display:grid; grid-template-columns:3fr 1.2fr; gap:16px}
    @media (max-width:980px){ .wrap{grid-template-columns:1fr} }

    /* ===== Board ===== */
    .board{background:#fff; border:2px solid #eee; border-radius:12px; padding:12px; position:relative; display:grid; gap:8px; grid-template-columns:repeat(var(--board-cols), minmax(52px, var(--cell-size))); grid-template-rows:repeat(var(--board-rows), minmax(52px, var(--cell-size))); overflow:hidden}
    .cell{background:#f9fafb; border:1px solid #e6e8eb; border-radius:10px; padding:6px; display:grid; place-items:center; font-size:12px; position:relative}
    .cell.start{background:#d1f7c4}
    .cell.goal{background:#cde7ff}
    .cell.event{background:#fff4cc}
    .cell.penalty{background:#ffe0e0}
    .cell.bonus{background:#e8ffea}
    .cell .idx{position:absolute; top:4px; left:6px; font-size:10px; color:#999}

    /* ===== Tokens ===== */
    .token{width:28px; height:28px; border-radius:50%; border:2px solid #333; display:grid; place-items:center; color:#fff; font-size:12px; font-weight:700; box-shadow:0 4px 10px rgba(0,0,0,.15); transition:transform 180ms ease; position:absolute}
    .token.finished{opacity:.6; border-color:#777}
    .token.active{outline:3px solid rgba(76,154,255,.5)}

    /* ===== Sidebar ===== */
    .sidebar{background:#fff; border:2px solid #eee; border-radius:12px; padding:12px; display:grid; gap:12px; height:fit-content}
    .stat{display:flex; justify-content:space-between; gap:8px; padding:8px 10px; background:#f5f7fa; border-radius:10px}
    .players{display:grid; gap:8px}
    .player-row{display:grid; grid-template-columns:1.6fr .8fr 1fr .8fr; gap:8px; align-items:center; padding:8px 10px; background:#fafcff; border:1px solid #eee; border-radius:10px}
    .player-row.active{border-color:var(--active); box-shadow:0 0 0 2px rgba(76,154,255,.2) inset}
    .badge{width:18px; height:18px; border-radius:50%; border:2px solid #333; display:inline-block; margin-right:6px}
    .money{justify-self:end; font-weight:700; transition:color 240ms ease, transform 240ms ease}
    .money.flash-plus{color:#0a7a2d; transform:scale(1.06)}
    .money.flash-minus{color:#b00020; transform:scale(.96)}

    .log{border:1px solid #eee; border-radius:10px; background:#fafcff; padding:10px; max-height:260px; overflow:auto; font-size:13px; line-height:1.4}
    .log p{margin:0 0 6px}
    .log p.ok{color:var(--ok)}
    .log p.bad{color:var(--bad)}
    .footer{font-size:12px; color:#777}

    /* ===== Modal ===== */
    dialog.modal{border:none; border-radius:12px; padding:0; width:min(92vw,520px)}
    .card{padding:16px; border-radius:12px; background:#fff}
    .card h3{margin:0 0 6px}
    .card p{margin:0 0 8px}
    .card .muted{color:#64748b; font-size:12px}
    .card .actions{display:flex; justify-content:flex-end; gap:8px}
    table{border-collapse:collapse; width:100%}
    th,td{border:1px solid #e5e7eb; padding:8px; text-align:left}
    th{background:#f8fafc}
  </style>
</head>
<body>
  <!-- App Bar -->
  <div class="appbar">
    <div class="toolbar" role="group" aria-label="ゲーム設定">
      <div class="title">人生ゲーム 改良版</div>
      <div class="group"><label for="players-count">人数</label><select id="players-count"><option value="2">2</option><option value="3">3</option><option value="4" selected>4</option></select></div>
      <div class="group"><label for="initial-money">初期資金</label><input id="initial-money" type="number" value="20000" min="0" step="1000" /></div>
      <div class="group"><label for="rng-seed">シード</label><input id="rng-seed" type="text" placeholder="任意(空=ランダム)" /></div>
      <div class="group"><label for="speed">速度</label><input id="speed" type="range" min="80" max="400" value="180" /></div>
      <div class="group"><label for="overshoot">ゴール超過</label><select id="overshoot"><option value="clamp" selected>止まる</option><option value="bounce">反射</option></select></div>
      <div class="dice" id="dice" aria-live="polite" aria-atomic="true">-</div>
      <button id="btn-start" class="primary">開始</button>
      <button id="btn-roll" disabled>サイコロ</button>
      <button id="btn-reset">リセット</button>
      <button id="btn-save" title="ローカルに保存">保存</button>
      <button id="btn-load" title="保存から読込">読込</button>
      <button id="btn-export" title="JSONエクスポート">Export</button>
      <input id="file-import" type="file" accept="application/json" hidden />
      <button id="btn-import" title="JSONインポート">Import</button>
    </div>
  </div>

  <div class="wrap">
    <main class="board" id="board" aria-label="ボード"></main>
    <aside class="sidebar">
      <div class="stat"><span>ターン</span><strong id="stat-turn">0</strong></div>
      <div class="stat"><span>手番</span><strong id="stat-current">-</strong></div>
      <div class="players" id="players-panel"></div>
      <div class="log" id="log" aria-live="polite" aria-atomic="false"></div>
      <div class="footer">Space/Enterでサイコロ。全員がゴールすると結果発表。</div>
    </aside>
  </div>

  <!-- Event Modal -->
  <dialog class="modal" id="modal">
    <div class="card">
      <h3 id="modal-title">イベント</h3>
      <p id="modal-text"></p>
      <p class="muted" id="modal-sub"></p>
      <div class="actions"><button id="modal-close" class="primary">OK</button></div>
    </div>
  </dialog>

  <!-- Result Modal -->
  <dialog class="modal" id="result">
    <div class="card">
      <h3>結果発表</h3>
      <div id="result-body"></div>
      <div class="actions"><button id="result-close" class="primary">閉じる</button></div>
    </div>
  </dialog>

  <script>
  // ====== DOM refs ======
  const $ = s => document.querySelector(s);
  const boardEl = $("#board"), logEl = $("#log"), diceEl = $("#dice");
  const statTurnEl = $("#stat-turn"), statCurrentEl = $("#stat-current");
  const playersPanelEl = $("#players-panel");
  const btnStart = $("#btn-start"), btnRoll = $("#btn-roll"), btnReset = $("#btn-reset");
  const btnSave = $("#btn-save"), btnLoad = $("#btn-load"), btnExport = $("#btn-export"), btnImport = $("#btn-import"), fileImport = $("#file-import");
  const playersCountSel = $("#players-count"), initialMoneyInput = $("#initial-money");
  const rngSeedInput = $("#rng-seed"), speedInput = $("#speed"), overshootSel = $("#overshoot");
  const modal = $("#modal"), modalTitle = $("#modal-title"), modalText = $("#modal-text"), modalSub = $("#modal-sub"), modalClose = $("#modal-close");
  const resultDlg = $("#result"), resultBody = $("#result-body"), resultClose = $("#result-close");

  // ====== Consts ======
  const BOARD_COLS = 8, BOARD_ROWS = 5, TOTAL_CELLS = BOARD_COLS * BOARD_ROWS;
  const PLAYER_COLORS = ["#ff6b6b", "#4c9aff", "#00c853", "#ff8f00", "#9c27b0", "#00acc1"];

  // RNG (seedable)
  function createRNG(seed){ if(!seed) return Math.random; let h=2166136261>>>0; for(let i=0;i<seed.length;i++){ h^=seed.charCodeAt(i); h=Math.imul(h,16777619);} return ()=>{ h+=0x6D2B79F5; let t=Math.imul(h^h>>>15,1|h); t^=t+Math.imul(t^t>>>7,61|t); return ((t^t>>>14)>>>0)/4294967296; }; }
  const randPick = (rng, arr)=> arr[Math.floor(rng()*arr.length)];
  const yen = n => "¥"+n.toLocaleString("ja-JP");
  const sleep = ms => new Promise(res=>setTimeout(res, ms));

  // Board cells
  const cells = Array.from({length:TOTAL_CELLS},(_,i)=>({index:i,type:"none",label:""}));
  cells[0] = {index:0,type:"start",label:"スタート"};
  cells[TOTAL_CELLS-1] = {index:TOTAL_CELLS-1,type:"goal",label:"ゴール"};
  const mark=(idxs,type,label)=> idxs.forEach(i=>{cells[i].type=type; cells[i].label=label});
  mark([3,6,9,12,15,18,23,27,31,33],"event","イベント");
  mark([4,10,16,22,30],"bonus","ボーナス");
  mark([8,14,20,26,34],"penalty","ペナルティ");

  const eventTable=[
    { text:"就職おめでとう！初任給で+¥30,000", money:+30000 },
    { text:"家賃の更新で-¥20,000", money:-20000 },
    { text:"副業がバズって+¥50,000", money:+50000 },
    { text:"スマホが壊れて-¥15,000", money:-15000 },
    { text:"推し活で-¥10,000", money:-10000 },
    { text:"奨学金が振り込まれた+¥40,000", money:+40000 },
    { text:"バイト昇給で+¥8,000", money:+8000 },
    { text:"体調不良で病院代-¥5,000", money:-5000 },
    { text:"フリマで売れて+¥6,000", money:+6000 },
    { text:"交通違反で-¥12,000", money:-12000 },
  ];

  // State
  const state={ started:false, turn:0, currentPlayerIndex:0, players:[], finishedCount:0, animating:false, rng:Math.random, seed:"", speed:180, overshoot:"clamp" };

  // Helpers
  function indexToGrid(index){ const row=Math.floor(index/BOARD_COLS); let col=index%BOARD_COLS; if(row%2===1) col=BOARD_COLS-1-col; return {row,col}; }
  function tokenId(i){ return `token-${i}` }

  // Render board
  function renderBoard(){
    boardEl.style.setProperty("--board-cols", BOARD_COLS);
    boardEl.style.setProperty("--board-rows", BOARD_ROWS);
    boardEl.innerHTML="";
    cells.forEach(cell=>{
      const div=document.createElement("div"); div.className="cell "+(cell.type!="none"?cell.type:""); div.dataset.index=String(cell.index);
      const idx=document.createElement("div"); idx.className="idx"; idx.textContent=String(cell.index); div.appendChild(idx);
      const label=document.createElement("div"); label.textContent=cell.label||""; div.appendChild(label);
      const {row,col}=indexToGrid(cell.index); div.style.gridRowStart=row+1; div.style.gridColumnStart=col+1; boardEl.appendChild(div);
    });
    state.players.forEach((pl,i)=>{ const t=document.createElement("div"); t.className="token"; t.id=tokenId(i); t.textContent=String(i+1); t.style.background=pl.color; if(pl.finished) t.classList.add("finished"); boardEl.appendChild(t); });
    placeAllTokens(); highlightActiveToken();
  }

  function placeAllTokens(){
    const groups=new Map(); state.players.forEach((pl,i)=>{ if(!groups.has(pl.position)) groups.set(pl.position, []); groups.get(pl.position).push(i); });
    groups.forEach((idxs,pos)=>{
      const targetCell=boardEl.querySelector(`.cell[data-index="${pos}"]`); if(!targetCell) return;
      const rectBoard=boardEl.getBoundingClientRect(); const rc=targetCell.getBoundingClientRect();
      const cx=rc.left-rectBoard.left+rc.width/2, cy=rc.top-rectBoard.top+rc.height/2; const r=Math.min(rc.width,rc.height)/3.2; const n=idxs.length; const base=-90;
      idxs.forEach((pi,k)=>{ const angle=base+(n===1?0:(k-(n-1)/2)*30); const rad=angle*Math.PI/180; const x=cx+r*Math.cos(rad)-14, y=cy+r*Math.sin(rad)-14; const t=$("#"+tokenId(pi)); if(t) t.style.transform=`translate(${x}px, ${y}px)`; });
    });
  }
  function highlightActiveToken(){ state.players.forEach((_,i)=>{ const t=$("#"+tokenId(i)); if(!t) return; if(i===state.currentPlayerIndex) t.classList.add("active"); else t.classList.remove("active"); }); }

  function moneyId(i){return `money-${i}`}
  function renderPlayersPanel(){ playersPanelEl.innerHTML=""; state.players.forEach((pl,i)=>{ const row=document.createElement("div"); row.className="player-row"+(i===state.currentPlayerIndex?" active":""); const name=document.createElement("div"); const badge=document.createElement("span"); badge.className="badge"; badge.style.background=pl.color; name.appendChild(badge); const nameText=document.createElement("span"); nameText.textContent=pl.name+(pl.finished?"（ゴール）":""); name.appendChild(nameText); const pos=document.createElement("div"); pos.textContent="位置: "+pl.position; const money=document.createElement("div"); money.className="money"; money.id=moneyId(i); money.textContent=yen(pl.money); const status=document.createElement("div"); status.textContent=pl.skipTurn?"次ターン休み":""; row.appendChild(name); row.appendChild(pos); row.appendChild(money); row.appendChild(status); playersPanelEl.appendChild(row); }); }
  function flashMoney(i,delta){ const el=$("#"+moneyId(i)); if(!el) return; const cls=delta>=0?"flash-plus":"flash-minus"; el.classList.add(cls); setTimeout(()=>el.classList.remove(cls), 400) }

  function pushLog(text,kind){ const p=document.createElement("p"); p.textContent=text; if(kind) p.classList.add(kind); logEl.appendChild(p); logEl.scrollTop=logEl.scrollHeight; }
  function showCard(title,text,sub){ modalTitle.textContent=title; modalText.textContent=text; modalSub.textContent=sub||""; modal.showModal(); }
  modalClose.addEventListener("click",()=> modal.close());

  function resolveCell(playerIndex,index){ const pl=state.players[playerIndex]; const cell=cells[index]; if(!cell||!pl) return; switch(cell.type){ case "start": pushLog(`${pl.name}: スタート！","ok"); break; case "goal": pl.finished=true; state.finishedCount+=1; $("#"+tokenId(playerIndex))?.classList.add("finished"); pushLog(`${pl.name}: ゴール！お疲れ！`); showCard("ゴール", `${pl.name} がゴール！`, `現在残高: ${yen(pl.money)}`); break; case "bonus":{ const amount=randPick(state.rng,[5000,8000,10000,15000,20000]); pl.money+=amount; flashMoney(playerIndex,amount); pushLog(`${pl.name}: ボーナス！${yen(amount)}獲得（残高: ${yen(pl.money)}）`,"ok"); break;} case "penalty":{ const amount=randPick(state.rng,[5000,8000,10000,15000,20000]); pl.money-=amount; flashMoney(playerIndex,-amount); pushLog(`${pl.name}: ペナルティ…${yen(amount)}失う（残高: ${yen(pl.money)}）`,"bad"); break;} case "event":{ const ev=randPick(state.rng,eventTable); pl.money+=ev.money; flashMoney(playerIndex,ev.money); pushLog(`${pl.name}: ${ev.text}（残高: ${yen(pl.money)}）`, ev.money>=0?"ok":"bad"); if(state.rng()<0.10){ pl.skipTurn=true; pushLog(`${pl.name}: 次のターンはお休み（スキップ）`); } showCard("イベント", ev.text, `${pl.name} / 残高: ${yen(pl.money)}`); break;} default: break; } renderPlayersPanel(); }

  function rollDice(){ const n=Math.floor(state.rng()*6)+1; diceEl.textContent=n; diceEl.classList.add("spin"); setTimeout(()=>diceEl.classList.remove("spin"),620); return n; }

  async function animateMove(playerIndex,steps){ const pl=state.players[playerIndex]; if(!pl||pl.finished) return; state.animating=true; btnRoll.disabled=true; const delay=Number(speedInput.value||state.speed); let pos=pl.position; let remain=steps; while(remain>0){ let next=pos+1; if(next>=TOTAL_CELLS-1){ if(state.overshoot==="clamp"){ next=TOTAL_CELLS-1; pos=next; pl.position=pos; placeAllTokens(); await sleep(delay); break; } else { const extra=remain-1-((TOTAL_CELLS-1)-pos-1); pos=TOTAL_CELLS-1; pl.position=pos; placeAllTokens(); await sleep(delay); for(let b=0;b<extra;b++){ pos-=1; pl.position=pos; placeAllTokens(); await sleep(delay); } remain=0; break; } } pos=next; pl.position=pos; placeAllTokens(); await sleep(delay); remain--; } resolveCell(playerIndex,pl.position); state.animating=false; }

  function nextPlayerTurn(){ const total=state.players.length; let i=state.currentPlayerIndex; for(let c=0;c<total;c++){ i=(i+1)%total; const p=state.players[i]; if(!p.finished){ state.currentPlayerIndex=i; break; } } highlightActiveToken(); renderPlayersPanel(); statCurrentEl.textContent=state.players[state.currentPlayerIndex].name; }
  const isGameFinished=()=> state.finishedCount===state.players.length;

  function openResult(){ const rows=state.players.map((p,i)=>({i,name:p.name,money:p.money})).sort((a,b)=>b.money-a.money); let html=`<table><thead><tr><th>順位</th><th>プレイヤー</th><th>所持金</th><th>差額</th></tr></thead><tbody>`; const top=rows[0]?.money??0; rows.forEach((r,idx)=>{ const diff=r.money-top; html+=`<tr><td>${idx+1}</td><td>${r.name}</td><td>${yen(r.money)}</td><td>${diff===0?"-":yen(diff)}</td></tr>`; }); html+=`</tbody></table>`; resultBody.innerHTML=html; resultDlg.showModal(); }
  resultClose.addEventListener("click",()=> resultDlg.close());

  const SAVE_KEY="life-game-save-v3";
  function snapshot(){ return JSON.stringify({ started:state.started, turn:state.turn, currentPlayerIndex:state.currentPlayerIndex, finishedCount:state.finishedCount, players:state.players, seed:state.seed, overshoot:state.overshoot, speed:Number(speedInput.value||state.speed) }); }
  function restore(json){ try{ const d=JSON.parse(json); state.started=d.started; state.turn=d.turn; state.currentPlayerIndex=d.currentPlayerIndex; state.finishedCount=d.finishedCount; state.players=d.players; state.seed=d.seed||""; state.overshoot=d.overshoot||"clamp"; state.rng=createRNG(state.seed||""); speedInput.value=String(d.speed||180); overshootSel.value=state.overshoot; rngSeedInput.value=state.seed; renderBoard(); renderPlayersPanel(); statTurnEl.textContent=String(state.turn); statCurrentEl.textContent=state.players[state.currentPlayerIndex]?.name||"-"; pushLog("保存データを読み込みました。","ok"); }catch(e){ alert("読み込みに失敗しました"); }}

  btnSave.addEventListener("click",()=>{ localStorage.setItem(SAVE_KEY, snapshot()); pushLog("保存しました","ok"); });
  btnLoad.addEventListener("click",()=>{ const s=localStorage.getItem(SAVE_KEY); if(!s) return alert("保存がありません"); restore(s); });
  btnExport.addEventListener("click",()=>{ const blob=new Blob([snapshot()],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="life-game-save.json"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); });
  btnImport.addEventListener("click",()=> fileImport.click());
  fileImport.addEventListener("change", async e=>{ const f=e.target.files?.[0]; if(!f) return; const txt=await f.text(); restore(txt); fileImport.value=""; });

  // Start/Reset/Roll
  btnStart.addEventListener("click",()=>{ if(state.started) return; const count=parseInt(playersCountSel.value,10); const initial=parseInt(initialMoneyInput.value,10)||0; const seed=(rngSeedInput.value||"").trim(); state.seed=seed; state.rng=createRNG(seed); state.players=Array.from({length:count},(_,i)=>({ name:`プレイヤー${i+1}`, color:PLAYER_COLORS[i%PLAYER_COLORS.length], position:0, money:initial, finished:false, skipTurn:false })); state.started=true; state.turn=1; state.currentPlayerIndex=0; state.finishedCount=0; state.overshoot=overshootSel.value; state.speed=Number(speedInput.value||180); pushLog(`ゲーム開始！初期資金: ${yen(initial)} | プレイヤー数: ${count} ${seed?`| シード:${seed}`:""}`,"ok"); renderBoard(); renderPlayersPanel(); statTurnEl.textContent=String(state.turn); statCurrentEl.textContent=state.players[state.currentPlayerIndex].name; btnRoll.disabled=false; diceEl.textContent='-'; });

  btnReset.addEventListener("click",()=>{ Object.assign(state,{started:false,turn:0,currentPlayerIndex:0,players:[],finishedCount:0,animating:false}); btnRoll.disabled=true; logEl.innerHTML=""; statTurnEl.textContent="0"; statCurrentEl.textContent="-"; diceEl.textContent='-'; renderBoard(); playersPanelEl.innerHTML=""; pushLog("リセットしました"); });

  btnRoll.addEventListener("click", async ()=>{ if(!state.started||state.animating) return; const pl=state.players[state.currentPlayerIndex]; if(!pl||pl.finished){ nextPlayerTurn(); return; } if(pl.skipTurn){ pushLog(`${pl.name}: ターンをスキップします`); pl.skipTurn=false; state.turn+=1; statTurnEl.textContent=String(state.turn); nextPlayerTurn(); return; } const dice=rollDice(); pushLog(`${pl.name}: サイコロ → ${dice}`); const remaining=(TOTAL_CELLS-1)-pl.position; const steps=state.overshoot==="clamp"? Math.min(dice,remaining): dice; await animateMove(state.currentPlayerIndex,steps); state.turn+=1; statTurnEl.textContent=String(state.turn); if(state.finishedCount===state.players.length){ pushLog("全員ゴール！ゲーム終了！"); btnRoll.disabled=true; openResult(); return; } nextPlayerTurn(); btnRoll.disabled=false; });

  window.addEventListener("keydown", e=>{ if(e.code==="Space"||e.key==="Enter"){ e.preventDefault(); btnRoll.click(); } if(e.key.toLowerCase()==='r'&&!state.animating){ btnReset.click(); } });

  renderBoard();
  window.addEventListener("resize", ()=> placeAllTokens());
  </script>
</body>
</html>
