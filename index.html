<!-- index.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>人生ゲーム（アイコン＋勝敗ルール対応）</title>
  <style>
    :root {
      --board-cols: 8;
      --board-rows: 5;
      --cell-size: 68px;
      --accent: #ff6b6b;
      --bg: #fffaf0;
      --text: #222;
      --active: #4c9aff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif;
      color: var(--text);
      background: var(--bg);
      display: grid;
      place-items: center;
      min-height: 100vh;
      padding: 16px;
    }
    .container {
      width: min(100%, 1100px);
      display: grid;
      grid-template-columns: 1fr 330px;
      gap: 16px;
    }
    @media (max-width: 900px) {
      .container { grid-template-columns: 1fr; }
    }
    header {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
    }
    header h1 { font-size: 1.6rem; margin: 0; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .controls .group {
      display: flex; gap: 6px; align-items: center; padding: 6px 8px; background: #fff; border: 1px solid #eee; border-radius: 10px;
    }
    label { font-size: 12px; color: #555; }
    select, input[type="number"] {
      padding: 6px 8px; border-radius: 8px; border: 1px solid #ddd; width: 90px;
    }
    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      font-weight: 600;
    }
    button.primary { background: var(--accent); color: #fff; border-color: transparent; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Board */
    .board {
      background: #fff;
      border: 2px solid #eee;
      border-radius: 12px;
      padding: 12px;
      display: grid;
      grid-template-columns: repeat(var(--board-cols), minmax(52px, var(--cell-size)));
      grid-template-rows: repeat(var(--board-rows), minmax(52px, var(--cell-size)));
      gap: 8px;
      position: relative;
    }
    .cell {
      background: #f9fafb;
      border: 1px solid #e6e8eb;
      border-radius: 10px;
      padding: 6px;
      display: grid;
      grid-template-rows: auto 1fr;
      place-items: center;
      font-size: 12px;
      position: relative;
      overflow: hidden;
    }
    .cell.start { background: #d1f7c4; }
    .cell.goal  { background: #cde7ff; }
    .cell.event { background: #fff4cc; }
    .cell.penalty { background: #ffe0e0; }
    .cell.bonus { background: #e8ffea; }

    .cell .idx {
      position: absolute;
      top: 4px; left: 6px;
      font-size: 10px; color: #999;
    }
    .cell .icon {
      font-size: 18px; line-height: 1; margin-top: 2px;
    }
    .cell .label {
      font-size: 11px; color: #333;
    }

    /* Player token */
    .token {
      width: 28px; height: 28px;
      border-radius: 50%;
      border: 2px solid #333;
      display: grid; place-items: center;
      color: #fff; font-size: 12px; font-weight: 700;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      transition: transform 180ms ease;
      position: absolute;
    }
    .token.finished { opacity: 0.6; border-color: #777; }
    .token.active { outline: 3px solid rgba(76,154,255,0.5); }

    /* Sidebar */
    .sidebar {
      background: #fff;
      border: 2px solid #eee;
      border-radius: 12px;
      padding: 12px;
      display: grid;
      gap: 12px;
      height: fit-content;
    }
    .stat {
      display: flex; justify-content: space-between; gap: 8px;
      padding: 8px 10px; background: #f5f7fa; border-radius: 10px;
    }
    .players { display: grid; gap: 8px; }
    .player-row {
      display: grid; grid-template-columns: 1.6fr 0.8fr 1fr 0.8fr;
      gap: 8px; align-items: center;
      padding: 8px 10px; background: #fafcff; border: 1px solid #eee; border-radius: 10px;
    }
    .player-row.active { border-color: var(--active); box-shadow: 0 0 0 2px rgba(76,154,255,0.2) inset; }
    .badge {
      width: 18px; height: 18px; border-radius: 50%; border: 2px solid #333; display: inline-block; margin-right: 6px;
    }
    .money {
      justify-self: end;
      font-weight: 700;
      transition: color 240ms ease, transform 240ms ease;
    }
    .money.flash-plus { color: #0a7a2d; transform: scale(1.06); }
    .money.flash-minus { color: #b00020; transform: scale(0.96); }

    .log {
      border: 1px solid #eee;
      border-radius: 10px;
      background: #fafcff;
      padding: 10px;
      max-height: 260px;
      overflow: auto;
      font-size: 13px;
      line-height: 1.4;
    }
    .log p { margin: 0 0 6px; }
    .footer { font-size: 12px; color: #777; }

    /* Result modal */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center; justify-content: center;
      z-index: 1000;
    }
    .modal {
      background: #fff; border-radius: 12px; padding: 16px; width: min(90vw, 520px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.2);
    }
    .modal h2 { margin: 0 0 8px; font-size: 1.4rem; }
    .ranking {
      display: grid; gap: 8px; margin-top: 8px;
    }
    .rank-row {
      display: grid; grid-template-columns: 40px 1fr 120px;
      gap: 8px; align-items: center;
      padding: 8px 10px; background: #f7fafc; border: 1px solid #eee; border-radius: 10px;
    }
    .rank-row .place { font-weight: 800; text-align: center; }
    .modal .actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>人生ゲーム（アイコン＋勝敗ルール）</h1>
      <div class="controls">
        <div class="group">
          <label for="players-count">人数</label>
          <select id="players-count">
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4" selected>4</option>
          </select>
        </div>
        <div class="group">
          <label for="initial-money">初期資金</label>
          <input id="initial-money" type="number" value="20000" min="0" step="1000" />
        </div>
        <button id="btn-start" class="primary">ゲーム開始</button>
        <button id="btn-roll" disabled>サイコロを振る</button>
        <button id="btn-reset">リセット</button>
      </div>
    </header>

    <main class="board" id="board"></main>

    <aside class="sidebar">
      <div class="stat"><span>ターン</span><strong id="stat-turn">0</strong></div>
      <div class="stat"><span>手番</span><strong id="stat-current">-</strong></div>
      <div class="players" id="players-panel"></div>
      <div class="log" id="log"></div>
      <div class="footer">ゴール順位＋最終残高で勝敗を決定します。</div>
    </aside>
  </div>

  <!-- Result Modal -->
  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal">
      <h2>結果発表</h2>
      <div class="ranking" id="ranking"></div>
      <div class="actions">
        <button id="btn-close">閉じる</button>
        <button id="btn-restart" class="primary">再戦（設定は維持）</button>
      </div>
    </div>
  </div>

  <script>
    const BOARD_COLS = 8;
    const BOARD_ROWS = 5;
    const TOTAL_CELLS = BOARD_COLS * BOARD_ROWS;

    const ICONS = { start:"🚀", goal:"🏁", event:"🎲", bonus:"🎁", penalty:"⚠️", none:"⬜️" };

    const cells = Array.from({ length: TOTAL_CELLS }, (_, i) => ({
      index: i, type: "none", label: "", icon: ICONS.none
    }));
    cells[0] = { index: 0, type: "start", label: "スタート", icon: ICONS.start };
    cells[TOTAL_CELLS - 1] = { index: TOTAL_CELLS - 1, type: "goal", label: "ゴール", icon: ICONS.goal };

    const eventIndices = [3,6,9,12,15,18,23,27,31,33];
    eventIndices.forEach(i => { cells[i].type = "event"; cells[i].label = "イベント"; cells[i].icon = ICONS.event; });

    const bonusIndices = [4,10,16,22,30];
    bonusIndices.forEach(i => { cells[i].type = "bonus"; cells[i].label = "ボーナス"; cells[i].icon = ICONS.bonus; });

    const penaltyIndices = [8,14,20,26,34];
    penaltyIndices.forEach(i => { cells[i].type = "penalty"; cells[i].label = "ペナルティ"; cells[i].icon = ICONS.penalty; });

    const eventTable = [
      { text: "就職おめでとう！初任給で+¥30,000", money: +30000 },
      { text: "家賃の更新で-¥20,000", money: -20000 },
      { text: "副業がバズって+¥50,000", money: +50000 },
      { text: "スマホが壊れて-¥15,000", money: -15000 },
      { text: "推し活で-¥10,000", money: -10000 },
      { text: "奨学金が振り込まれた+¥40,000", money: +40000 },
      { text: "バイト昇給で+¥8,000", money: +8000 },
      { text: "体調不良で病院代-¥5,000", money: -5000 },
      { text: "フリマで売れて+¥6,000", money: +6000 },
      { text: "交通違反で-¥12,000", money: -12000 },
    ];

    const PLAYER_COLORS = ["#ff6b6b","#4c9aff","#00c853","#ff8f00"];

    // 勝敗計算
    function computeRanking(players) {
      const finished = players.filter(p => p.finished);
      const unfinished = players.filter(p => !p.finished);

      finished.sort((a, b) => {
        if (a.finishOrder !== b.finishOrder) return a.finishOrder - b.finishOrder;
        return b.money - a.money;
      });

      unfinished.sort((a, b) => {
        if (a.position !== b.position) return b.position - a.position;
        return b.money - a.money;
      });

      const combined = finished.concat(unfinished);
      const ranking = [];
      let currentPlace = 1;
      for (let i = 0; i < combined.length; i++) {
        const p = combined[i];
        let place = currentPlace;
        if (i > 0) {
          const prev = combined[i-1];
          const sameCategory = (p.finished === prev.finished);
          const sameKey = p.finished
            ? (p.finishOrder === prev.finishOrder && p.money === prev.money)
            : (p.position === prev.position && p.money === prev.money);
          if (!sameCategory || !sameKey) {
            place = i + 1;
            currentPlace = place;
          }
        }
        ranking.push({ place, name: p.name, money: p.money, finished: p.finished, position: p.position });
      }
      return ranking;
    }

    // 状態
    const state = {
      started: false,
      turn: 0,
      currentPlayerIndex: 0,
      players: [],
      finishedCount: 0,
      animating: false,
      nextFinishOrder: 1,
    };

    // DOM
    const $ = s => document.querySelector(s);
    const boardEl = $("#board");
    const logEl = $("#log");
    const statTurnEl = $("#stat-turn");
    const statCurrentEl = $("#stat-current");
    const playersPanelEl = $("#players-panel");
    const btnStart = $("#btn-start");
    const btnRoll = $("#btn-roll");
    const btnReset = $("#btn-reset");
    const playersCountSel = $("#players-count");
    const initialMoneyInput = $("#initial-money");
    const modalBackdrop = $("#modal-backdrop");
    const rankingEl = $("#ranking");
    const btnClose = $("#btn-close");
    const btnRestart = $("#btn-restart");

    function yen(n) { return "¥" + n.toLocaleString("ja-JP"); }
    function appendLog(text) {
      const p = document.createElement("p");
      p.textContent = text;
      logEl.appendChild(p);
      logEl.scrollTop = logEl.scrollHeight;
    }
    function indexToGrid(index) {
      const row = Math.floor(index / BOARD_COLS);
      let col = index % BOARD_COLS;
      if (row % 2 === 1) col = BOARD_COLS - 1 - col;
      return { row, col };
    }

    function tokenId(i) { return `token-${i}`; }
    function moneyId(i) { return `money-${i}`; }

    function renderBoard() {
      boardEl.style.setProperty("--board-cols", BOARD_COLS);
      boardEl.style.setProperty("--board-rows", BOARD_ROWS);
      boardEl.innerHTML = "";
      cells.forEach(cell => {
        const div = document.createElement("div");
        div.className = "cell " + (cell.type !== "none" ? cell.type : "");
        div.dataset.index = String(cell.index);

        const idx = document.createElement("div");
        idx.className = "idx";
        idx.textContent = String(cell.index);
        div.appendChild(idx);

        const icon = document.createElement("div");
        icon.className = "icon";
        icon.textContent = cell.icon || "";
        div.appendChild(icon);

        const label = document.createElement("div");
        label.className = "label";
        label.textContent = cell.label || "";
        div.appendChild(label);

        const { row, col } = indexToGrid(cell.index);
        div.style.gridRowStart = row + 1;
        div.style.gridColumnStart = col + 1;

        boardEl.appendChild(div);
      });

      state.players.forEach((pl, i) => {
        const token = document.createElement("div");
        token.className = "token";
        token.id = tokenId(i);
        token.textContent = String(i + 1);
        token.style.background = pl.color;
        if (pl.finished) token.classList.add("finished");
        boardEl.appendChild(token);
        placeToken(i, pl.position);
      });
      highlightActiveToken();
    }

    function placeToken(playerIndex, cellIndex) {
      const targetCell = boardEl.querySelector(`.cell[data-index="${cellIndex}"]`);
      const token = $("#"+tokenId(playerIndex));
      if (!targetCell || !token) return;
      const rectParent = boardEl.getBoundingClientRect();
      const rectCell = targetCell.getBoundingClientRect();
      const x = rectCell.left - rectParent.left + rectCell.width / 2;
      const y = rectCell.top - rectParent.top + rectCell.height / 2;
      token.style.transform = `translate(${x - 14}px, ${y - 14}px)`;
    }

    function highlightActiveToken() {
      state.players.forEach((_, i) => {
        const t = $("#"+tokenId(i));
        if (!t) return;
        if (i === state.currentPlayerIndex) t.classList.add("active");
        else t.classList.remove("active");
      });
    }

    function renderPlayersPanel() {
      playersPanelEl.innerHTML = "";
      state.players.forEach((pl, i) => {
        const row = document.createElement("div");
        row.className = "player-row" + (i === state.currentPlayerIndex ? " active" : "");
        const name = document.createElement("div");
        const badge = document.createElement("span");
        badge.className = "badge"; badge.style.background = pl.color;
        name.appendChild(badge);
        const nameText = document.createElement("span");
        nameText.textContent = pl.name + (pl.finished ? `（ゴール${pl.finishOrder ? `#${pl.finishOrder}` : ""}）` : "");
        name.appendChild(nameText);

        const pos = document.createElement("div");
        pos.textContent = "位置: " + pl.position;

        const money = document.createElement("div");
        money.className = "money";
        money.id = moneyId(i);
        money.textContent = yen(pl.money);

        const status = document.createElement("div");
        status.textContent = pl.skipTurn ? "次ターン休み" : "";

        row.appendChild(name);
        row.appendChild(pos);
        row.appendChild(money);
        row.appendChild(status);
        playersPanelEl.appendChild(row);
      });
    }

    function flashMoney(playerIndex, delta) {
      const el = $("#"+moneyId(playerIndex));
      if (!el) return;
      const cls = delta >= 0 ? "flash-plus" : "flash-minus";
      el.classList.add(cls);
      setTimeout(() => el.classList.remove(cls), 400);
    }
    function resolveCell(playerIndex, index) {
      const pl = state.players[playerIndex];
      const cell = cells[index];
      if (!cell || !pl) return;

      switch (cell.type) {
        case "start":
          appendLog(`${pl.name}: スタート！`);
          break;
        case "goal":
          appendLog(`${pl.name}: ゴール！お疲れさま！`);
          if (!pl.finished) {
            pl.finished = true;
            pl.finishOrder = state.nextFinishOrder++;
            state.finishedCount += 1;
            const token = document.getElementById(tokenId(playerIndex));
            if (token) token.classList.add("finished");
          }
          break;
        case "bonus": {
          const amount = [5000, 8000, 10000, 15000, 20000][Math.floor(Math.random() * 5)];
          pl.money += amount;
          appendLog(`${pl.name}: ボーナス！${yen(amount)}獲得（残高: ${yen(pl.money)}）`);
          flashMoney(playerIndex, amount);
          break;
        }
        case "penalty": {
          const amount = [5000, 8000, 10000, 15000, 20000][Math.floor(Math.random() * 5)];
          pl.money -= amount;
          appendLog(`${pl.name}: ペナルティ…${yen(amount)}失う（残高: ${yen(pl.money)}）`);
          flashMoney(playerIndex, -amount);
          break;
        }
        case "event": {
          const ev = eventTable[Math.floor(Math.random() * eventTable.length)];
          pl.money += ev.money;
          appendLog(`${pl.name}: ${ev.text}（残高: ${yen(pl.money)}）`);
          flashMoney(playerIndex, ev.money);
          if (Math.random() < 0.1) {
            pl.skipTurn = true;
            appendLog(`${pl.name}: 次のターンはお休み（スキップ）`);
          }
          break;
        }
        default: break;
      }
      renderPlayersPanel();
    }

    const sleep = ms => new Promise(res => setTimeout(res, ms));

    async function animateMove(playerIndex, steps) {
      const pl = state.players[playerIndex];
      if (!pl || pl.finished) return;

      state.animating = true;
      btnRoll.disabled = true;

      for (let s = 0; s < steps; s++) {
        let nextPos = pl.position + 1;
        if (nextPos >= TOTAL_CELLS - 1) nextPos = TOTAL_CELLS - 1;
        pl.position = nextPos;
        placeToken(playerIndex, pl.position);
        await sleep(180);

        if (s === steps - 1) resolveCell(playerIndex, pl.position);
        if (pl.position === TOTAL_CELLS - 1) break;
      }

      state.animating = false;
    }

    function nextPlayerTurn() {
      const total = state.players.length;
      let i = state.currentPlayerIndex;
      for (let c = 0; c < total; c++) {
        i = (i + 1) % total;
        const p = state.players[i];
        if (!p.finished) {
          state.currentPlayerIndex = i;
          break;
        }
      }
      highlightActiveToken();
      renderPlayersPanel();
      statCurrentEl.textContent = state.players[state.currentPlayerIndex].name;
    }

    function isGameFinished() {
      return state.finishedCount === state.players.length;
    }

    function showResultModal() {
      const ranking = computeRanking(state.players);
      rankingEl.innerHTML = "";
      appendLog("結果発表：");
      ranking.forEach(r => {
        const row = document.createElement("div");
        row.className = "rank-row";
        const place = document.createElement("div");
        place.className = "place";
        place.textContent = r.place + "位";
        const name = document.createElement("div");
        name.textContent = r.name + (r.finished ? "" : `（未ゴール/位置${r.position}）`);
        const money = document.createElement("div");
        money.textContent = yen(r.money);

        row.appendChild(place);
        row.appendChild(name);
        row.appendChild(money);
        rankingEl.appendChild(row);

        appendLog(`${r.place}位: ${r.name}（${r.finished ? "ゴール" : "未ゴール"} / 残高: ${yen(r.money)}）`);
      });
      modalBackdrop.style.display = "flex";
    }

    btnClose.addEventListener("click", () => {
      modalBackdrop.style.display = "none";
    });
    btnRestart.addEventListener("click", () => {
      modalBackdrop.style.display = "none";
      resetGame(false);
      startGame();
    });

    btnStart.addEventListener("click", () => {
      if (state.started) return;
      startGame();
    });

    function startGame() {
      const count = parseInt(playersCountSel.value, 10);
      const initial = parseInt(initialMoneyInput.value, 10) || 0;

      state.players = Array.from({ length: count }, (_, i) => ({
        name: `プレイヤー${i + 1}`,
        color: PLAYER_COLORS[i % PLAYER_COLORS.length],
        position: 0,
        money: initial,
        finished: false,
        skipTurn: false,
        finishOrder: null,
      }));
      state.started = true;
      state.turn = 1;
      state.currentPlayerIndex = 0;
      state.finishedCount = 0;
      state.nextFinishOrder = 1;

      appendLog(`ゲーム開始！初期資金: ${yen(initial)} | プレイヤー数: ${count}`);
      renderBoard();
      renderPlayersPanel();
      statTurnEl.textContent = String(state.turn);
      statCurrentEl.textContent = state.players[state.currentPlayerIndex].name;
      btnRoll.disabled = false;
    }

    btnRoll.addEventListener("click", async () => {
      if (!state.started || state.animating) return;

      const pl = state.players[state.currentPlayerIndex];
      if (!pl || pl.finished) { nextPlayerTurn(); return; }

      if (pl.skipTurn) {
        appendLog(`${pl.name}: ターンをスキップします`);
        pl.skipTurn = false;
        state.turn += 1;
        statTurnEl.textContent = String(state.turn);
        nextPlayerTurn();
        return;
      }

      const dice = Math.floor(Math.random() * 6) + 1;
      appendLog(`${pl.name}: サイコロ → ${dice}`);

      const remaining = (TOTAL_CELLS - 1) - pl.position;
      const steps = Math.min(dice, remaining);

      await animateMove(state.currentPlayerIndex, steps);

      state.turn += 1;
      statTurnEl.textContent = String(state.turn);

      if (isGameFinished()) {
        appendLog("全員ゴール！ゲーム終了！");
        btnRoll.disabled = true;
        showResultModal();
        return;
      }

      nextPlayerTurn();
      btnRoll.disabled = false;
    });

    btnReset.addEventListener("click", () => {
      resetGame(true);
    });

    function resetGame(addLog) {
      state.started = false;
      state.turn = 0;
      state.currentPlayerIndex = 0;
      state.players = [];
      state.finishedCount = 0;
      state.animating = false;
      state.nextFinishOrder = 1;
      btnRoll.disabled = true;
      if (addLog) appendLog("リセットしました");
      logEl.innerHTML = "";
      statTurnEl.textContent = "0";
      statCurrentEl.textContent = "-";
      renderBoard();
      playersPanelEl.innerHTML = "";
   
    // 初期盤面の描画（ゲーム未開始時）
    renderBoard();

    // レイアウト変化時はトークン位置を再計算
    window.addEventListener("resize", () => {
      state.players.forEach((pl, i) => placeToken(i, pl.position));
    });
  </script>
</body>
</html>
