<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>äººç”Ÿã‚²ãƒ¼ãƒ  ver-17</title>
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <style>
    :root{
      --board-cols:8; --board-rows:5; --cell-size:72px;
      --accent:#ff6b6b; --bg:#fffaf0; --text:#222; --active:#4c9aff;
      --ok:#00c853; --warn:#ff8f00; --bad:#e53935; --muted:#94a3b8;
      --zoom-step:8px;
      --board-max-width: calc(var(--cell-size) * var(--board-cols) + 32px);
      --kpi-bar-height:10px;
      --toolbar-height:56px;
      --btn-size:36px;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0}
    body{
      display:flex; flex-direction:column; align-items:stretch;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic","Meiryo",sans-serif;
      color:var(--text); background:var(--bg);
      min-height:100vh;
    }

    /* ===== Toolbar (single line, but keep form controls visible) ===== */
    .appbar{
      position:sticky; top:0; z-index:60; width:100%;
      background:linear-gradient(180deg, rgba(255,250,240,.98), rgba(255,250,240,.9));
      backdrop-filter:saturate(1.05); border-bottom:1px solid rgba(0,0,0,.04);
    }
    .toolbar{height:var(--toolbar-height); display:flex; gap:10px; align-items:center; padding:6px 12px; max-width:1200px; margin:0 auto; flex-wrap:wrap}

    .app-title{display:flex; gap:8px; align-items:center; font-weight:800}
    .logo{width:36px;height:36px;border-radius:8px;display:grid;place-items:center;background:linear-gradient(180deg,#fff6ee,#ffe9d6)}

    .scenario-select{min-width:180px; padding:6px 8px;border-radius:8px;border:1px solid #e6e8eb;background:#fff;font-weight:600}
    .icon-btn{width:var(--btn-size);height:var(--btn-size);display:grid;place-items:center;border-radius:8px;border:1px solid #e6e8eb;background:#fff;cursor:pointer;position:relative}
    .icon-btn.primary{background:var(--accent);color:#fff;border-color:transparent}
    .small-input{padding:6px 8px;border-radius:8px;border:1px solid #e6e8eb;background:#fff}

    .dice{width:44px;height:36px;display:grid;place-items:center;border-radius:8px;border:1px solid #e6e8eb;background:#fff;font-weight:800}

    /* rest (board/sidebar) - similar to prior */
    .wrap{width:100%; padding:12px; display:grid; grid-template-columns:3fr 1.1fr; gap:10px; flex:1; align-items:start}
    @media (max-width:980px){ .wrap{grid-template-columns:1fr} }

    .board-wrap{display:flex; justify-content:center; align-items:flex-start}
    .board{background:#fff; border:2px solid #eee; border-radius:12px; padding:8px; position:relative; display:grid; gap:6px;
      grid-template-columns:repeat(var(--board-cols), var(--cell-size));
      grid-auto-rows: var(--cell-size);
      justify-content:center; align-content:start;
      max-width: var(--board-max-width);
    }
    .cell{background:#f9fafb;border:1px solid #e6e8eb;border-radius:10px;padding:6px;display:grid;place-items:center;font-size:12px;position:relative}
    .cell.start{background:#d1f7c4}.cell.goal{background:#cde7ff}.cell.event{background:#fff4cc}.cell.penalty{background:#ffe0e0}.cell.bonus{background:#e8ffea}
    .cell .idx{position:absolute;top:4px;left:6px;font-size:10px;color:#999}

    .token{width:28px;height:28px;border-radius:50%;border:2px solid #333;display:grid;place-items:center;color:#fff;font-size:12px;font-weight:700;box-shadow:0 4px 10px rgba(0,0,0,.15);transition:transform .18s ease}
    .token.finished{opacity:.6;border-color:#777}.token.active{outline:3px solid rgba(76,154,255,.5)}

    .sidebar{background:#fff;border:2px solid #eee;border-radius:12px;padding:12px;display:grid;gap:12px;height:fit-content}
    .stat{display:flex;justify-content:space-between;gap:8px;padding:8px 10px;background:#f5f7fa;border-radius:10px}
    .players{display:grid;gap:8px}
    .player-row{display:grid;grid-template-columns:1.35fr .8fr .8fr .8fr;gap:8px;align-items:center;padding:8px 10px;background:#fafcff;border:1px solid #eee;border-radius:10px}
    .player-row.active{border-color:var(--active);box-shadow:inset 0 0 0 2px rgba(76,154,255,.15)}
    .badge{width:18px;height:18px;border-radius:50%;border:2px solid #333;display:inline-block;margin-right:6px}
    .ach-badge{background:#ffd54f;color:#111;padding:4px 8px;border-radius:8px;font-weight:700;font-size:12px}
    .money{justify-self:end;font-weight:700}
    .kpi{display:grid;gap:8px;padding:8px;border-radius:8px;background:#fff;border:1px solid #eee}
    .kpi-row{display:grid;grid-template-columns:1fr 80px;gap:8px;align-items:center}
    .kpi-bar{height:var(--kpi-bar-height);background:#eee;border-radius:6px;overflow:hidden}
    .kpi-bar>.fill{height:100%;background:linear-gradient(90deg,#4c9aff,#00c853);width:0%}
    #tooltip{position:fixed;pointer-events:none;z-index:200;background:rgba(20,20,20,.95);color:#fff;padding:6px 10px;border-radius:6px;font-size:13px;display:none;white-space:nowrap}
  </style>
</head>
<body>
  <div class="appbar">
    <div class="toolbar" role="group" aria-label="ã‚²ãƒ¼ãƒ è¨­å®š">
      <div class="app-title">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none"><circle cx="6" cy="6" r="3" fill="#ff6b6b"/><circle cx="18" cy="6" r="3" fill="#4c9aff"/><circle cx="6" cy="18" r="3" fill="#00c853"/><circle cx="18" cy="18" r="3" fill="#ff8f00"/></svg>
        </div>
        <div style="display:flex;flex-direction:column;line-height:1">
          <div style="font-size:14px">äººç”Ÿã‚²ãƒ¼ãƒ </div>
          <div style="font-size:11px;color:var(--muted)">ver-17 â€” ãƒ‡ãƒãƒƒã‚°çµ±åˆç‰ˆ</div>
        </div>
      </div>

      <!-- Scenario & controls -->
      <select id="scenario-select" class="scenario-select" title="ã‚±ãƒ¼ã‚¹ã‚’é¸æŠ"></select>
      <button id="btn-manage-scenarios" class="small-input" title="ã‚·ãƒŠãƒªã‚ªç®¡ç†">ç®¡ç†</button>

      <!-- Keep essential controls visible (compact) -->
      <input id="players-count" type="number" class="small-input" value="4" min="1" max="6" title="äººæ•°" style="width:64px"/>
      <input id="initial-money" class="small-input" type="number" value="20000" title="åˆæœŸè³‡é‡‘" style="width:120px"/>

      <input id="rng-seed" class="small-input" type="text" placeholder="seed (ä»»æ„)" title="ä¹±æ•°ã‚·ãƒ¼ãƒ‰" style="width:120px"/>
      <input id="speed" type="range" min="80" max="400" value="180" title="é€Ÿåº¦" style="width:120px"/>
      <select id="overshoot" class="small-input" title="ã‚´ãƒ¼ãƒ«è¶…é"><option value="clamp" selected>æ­¢ã¾ã‚‹</option><option value="bounce">åå°„</option></select>

      <!-- Icon actions -->
      <button id="btn-start" class="icon-btn primary" data-tooltip="é–‹å§‹" title="é–‹å§‹" aria-label="é–‹å§‹">
        <svg width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M8 5v14l11-7z"/></svg>
      </button>
      <button id="btn-roll" class="icon-btn" data-tooltip="ã‚µã‚¤ã‚³ãƒ­" title="ã‚µã‚¤ã‚³ãƒ­" aria-label="ã‚µã‚¤ã‚³ãƒ­" disabled>
        <svg width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2l3 6 6 3-6 3-3 6-3-6-6-3 6-3z"/></svg>
      </button>
      <div id="dice" class="dice" aria-live="polite" aria-atomic="true">-</div>
      <button id="btn-reset" class="icon-btn" data-tooltip="ãƒªã‚»ãƒƒãƒˆ" title="ãƒªã‚»ãƒƒãƒˆ" aria-label="ãƒªã‚»ãƒƒãƒˆ">
        <svg width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M12 6V3L8 7l4 4V8c2.7 0 5 2.3 5 5 0 2.8-2.3 5-5 5s-5-2.2-5-5H5c0 4 3 8 7 8s7-4 7-8c0-4-3-8-7-8z"/></svg>
      </button>

      <!-- save slots -->
      <select id="save-slot" class="small-input" title="ä¿å­˜ã‚¹ãƒ­ãƒƒãƒˆ"><option value="1">Slot1</option><option value="2">Slot2</option><option value="3">Slot3</option></select>
      <button id="btn-save-slot" class="icon-btn" data-tooltip="ä¿å­˜" title="ä¿å­˜">ğŸ’¾</button>
      <button id="btn-load-slot" class="icon-btn" data-tooltip="èª­è¾¼" title="èª­è¾¼">ğŸ“‚</button>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="btn-zoom-in" class="icon-btn" title="ã‚ºãƒ¼ãƒ ã‚¤ãƒ³" data-tooltip="ã‚ºãƒ¼ãƒ ï¼‹">ï¼‹</button>
        <button id="btn-zoom-out" class="icon-btn" title="ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆ" data-tooltip="ã‚ºãƒ¼ãƒ âˆ’">âˆ’</button>
        <button id="btn-fit" class="icon-btn" title="ãƒ•ã‚£ãƒƒãƒˆ" data-tooltip="ãƒ•ã‚£ãƒƒãƒˆ">â¤¢</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="board-wrap">
      <main class="board" id="board" aria-label="ãƒœãƒ¼ãƒ‰"></main>
    </div>
    <aside class="sidebar">
      <div class="kpi" id="kpi-dashboard" aria-live="polite">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <strong>KPI ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</strong>
          <small id="scenario-summary" class="muted"></small>
        </div>
        <div class="kpi-row"><div>äºˆç®—æ®‹é«˜</div><div id="kpi-budget" style="text-align:right">-</div></div>
        <div class="kpi-row"><div>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæº€è¶³åº¦</div><div style="width:100%"><div class="kpi-bar"><div id="kpi-client-fill" class="fill" style="width:0%"></div></div></div></div>
        <div class="kpi-row"><div>é€²æ—</div><div style="width:100%"><div class="kpi-bar"><div id="kpi-progress-fill" class="fill" style="width:0%"></div></div></div></div>
        <div class="kpi-row"><div>ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ(ç´¯ç©åæ”¯)</div><div id="kpi-impact" style="text-align:right">-</div></div>
      </div>

      <div class="stat"><span>ã‚¿ãƒ¼ãƒ³</span><strong id="stat-turn">0</strong></div>
      <div class="stat"><span>æ‰‹ç•ª</span><strong id="stat-current">-</strong></div>
      <div class="players" id="players-panel"></div>
      <div class="log" id="log" aria-live="polite" aria-atomic="false"></div>
      <div class="footer">Space/Enterã§ã‚µã‚¤ã‚³ãƒ­ã€‚å…¨å“¡ãŒã‚´ãƒ¼ãƒ«ã™ã‚‹ã¨çµæœç™ºè¡¨ã€‚</div>
    </aside>
  </div>

  <div id="tooltip" role="tooltip" aria-hidden="true"></div>

  <!-- Minimal modals (kept compact for this build) -->
  <dialog class="modal" id="modal"><div class="card"><h3 id="modal-title">ã‚¤ãƒ™ãƒ³ãƒˆ</h3><div id="modal-text"></div><div id="modal-sub" class="muted"></div><div id="modal-actions" style="margin-top:12px"><button id="modal-close" class="icon-btn primary">OK</button></div></div></dialog>
  <dialog class="modal" id="result"><div class="card"><h3>çµæœç™ºè¡¨</h3><div id="result-body"></div><div style="margin-top:12px"><button id="result-close" class="icon-btn primary">é–‰ã˜ã‚‹</button></div></div></dialog>

  <script>
  // ver-17: restore v13 behavior, fix runtime errors, add icon hover tooltips
  (function(){
    const $ = s => document.querySelector(s);

    // Tooltip for icons and general tooltips
    const tooltip = $("#tooltip");
    function showTooltip(text, e){
      if(!text) return;
      tooltip.textContent = text;
      tooltip.style.display = "block";
      positionTooltip(e);
    }
    function positionTooltip(e){
      const pad = 10;
      const left = Math.min(window.innerWidth - tooltip.offsetWidth - 8, e.clientX + pad);
      const top = Math.min(window.innerHeight - tooltip.offsetHeight - 8, e.clientY + pad);
      tooltip.style.left = left + "px";
      tooltip.style.top = top + "px";
    }
    function hideTooltip(){ tooltip.style.display = "none"; }

    // Attach icon hover tooltips
    document.querySelectorAll('[data-tooltip]').forEach(btn=>{
      btn.addEventListener('mouseenter', e => showTooltip(btn.getAttribute('data-tooltip'), e));
      btn.addEventListener('mousemove', e => positionTooltip(e));
      btn.addEventListener('mouseleave', hideTooltip);
    });

    // DOM refs
    const boardEl = $("#board"), logEl = $("#log"), diceEl = $("#dice");
    const statTurnEl = $("#stat-turn"), statCurrentEl = $("#stat-current");
    const playersPanelEl = $("#players-panel");
    const btnStart = $("#btn-start"), btnRoll = $("#btn-roll"), btnReset = $("#btn-reset");
    const playersCountSel = $("#players-count"), initialMoneyInput = $("#initial-money");
    const rngSeedInput = $("#rng-seed"), speedInput = $("#speed"), overshootSel = $("#overshoot");
    const scenarioSelect = $("#scenario-select"), btnManageScenarios = $("#btn-manage-scenarios");
    const kpiBudgetEl = $("#kpi-budget"), kpiClientFill = $("#kpi-client-fill"), kpiProgressFill = $("#kpi-progress-fill"), kpiImpactEl = $("#kpi-impact"), scenarioSummaryEl = $("#scenario-summary");
    const btnSaveSlot = $("#btn-save-slot"), btnLoadSlot = $("#btn-load-slot"), saveSlotSel = $("#save-slot");

    // Basic constants
    const BOARD_COLS = 8, BOARD_ROWS = 5, TOTAL_CELLS = BOARD_COLS * BOARD_ROWS;
    const PLAYER_COLORS = ["#ff6b6b", "#4c9aff", "#00c853", "#ff8f00", "#9c27b0", "#00acc1"];
    const BRANCH_CHANCE = 0.30;

    // Scenario store
    const SCENARIO_KEY = "ltm-scenarios-v1";
    let scenarios = [];
    const DEFAULT_SCENARIOS = [
      { id:"dx-intro", title:"DXå°å…¥æ”¯æ´ï¼ˆä¸­å°ä¼æ¥­ï¼‰", description:"ãƒ¬ã‚¬ã‚·ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¯ãƒ©ã‚¦ãƒ‰ç§»è¡Œã¨æ¥­å‹™åŠ¹ç‡åŒ–ã€‚æœŸé™ã¨äºˆç®—ãŒå³ã—ã„ã€‚", budget:200000, deadlineTurns:20, kpis:{clientSatisfactionTarget:80, progressTarget:100, budgetTarget:0} },
      { id:"process-revamp", title:"æ¥­å‹™æ”¹é©ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰", description:"ç¾å ´ã®æŠµæŠ—ãŒå¼·ã„ãŒã‚³ã‚¹ãƒˆå‰Šæ¸›ã‚’æ±‚ã‚ã‚‰ã‚Œã¦ã„ã‚‹æ¡ˆä»¶ã€‚", budget:150000, deadlineTurns:16, kpis:{clientSatisfactionTarget:70, progressTarget:100, budgetTarget:0} },
      { id:"strategy", title:"ä¸­æœŸçµŒå–¶è¨ˆç”»ç­–å®š", description:"çµŒå–¶å±¤å‘ã‘ã®æˆ¦ç•¥ææ¡ˆã€‚æˆæœã¯æº€è¶³åº¦ä¾å­˜ã€‚", budget:120000, deadlineTurns:12, kpis:{clientSatisfactionTarget:85, progressTarget:100, budgetTarget:0} }
    ];
    function saveScenarios(){ try{ localStorage.setItem(SCENARIO_KEY, JSON.stringify(scenarios)); }catch(e){} }
    function loadScenarios(){ try{ const s = localStorage.getItem(SCENARIO_KEY); if(s){ scenarios = JSON.parse(s); return; } }catch(e){} scenarios = JSON.parse(JSON.stringify(DEFAULT_SCENARIOS)); saveScenarios(); }
    loadScenarios();

    function rebuildScenarioSelect(){
      scenarioSelect.innerHTML = "";
      scenarios.forEach(s => { const opt = document.createElement("option"); opt.value = s.id; opt.textContent = s.title; scenarioSelect.appendChild(opt); });
    }
    rebuildScenarioSelect();

    // Runtime state and KPIs
    let currentScenario = null;
    let KPIs = { budgetRemaining:0, clientSatisfaction:50, progress:0, impact:0 };
    function loadScenarioToState(sid){
      const s = scenarios.find(x=>x.id===sid) || scenarios[0];
      currentScenario = JSON.parse(JSON.stringify(s));
      KPIs.budgetRemaining = currentScenario.budget;
      KPIs.clientSatisfaction = 50;
      KPIs.progress = 0;
      KPIs.impact = 0;
      updateKPIDisplay();
      scenarioSummaryEl.textContent = currentScenario.title;
    }
    if(scenarios.length>0) { scenarioSelect.value = scenarios[0].id; loadScenarioToState(scenarios[0].id); }
    scenarioSelect.addEventListener("change", e=> loadScenarioToState(e.target.value));
    btnManageScenarios.addEventListener("click", ()=> { alert('ã‚·ãƒŠãƒªã‚ªç®¡ç†ã¯ç°¡æ˜“ãƒ¢ãƒ¼ãƒ‰ã€‚å¿…è¦ãªã‚‰è©³ç´°ç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚'); });

    function updateKPIDisplay(){
      kpiBudgetEl.textContent = `Â¥${Number(KPIs.budgetRemaining).toLocaleString()}`;
      kpiImpactEl.textContent = `Â¥${Number(KPIs.impact).toLocaleString()}`;
      kpiClientFill.style.width = `${Math.max(0, Math.min(100, KPIs.clientSatisfaction))}%`;
      kpiProgressFill.style.width = `${Math.max(0, Math.min(100, KPIs.progress))}%`;
    }

    // Helpers
    function createRNG(seed){ if(!seed) return Math.random; let h = 2166136261 >>> 0; for (let i=0;i<seed.length;i++){ h ^= seed.charCodeAt(i); h = Math.imul(h,16777619);} return ()=>{ h+=0x6D2B79F5; let t = Math.imul(h ^ h>>>15, 1 | h); t ^= t + Math.imul(t ^ t>>>7, 61 | h); return ((t ^ t>>>14)>>>0)/4294967296; }; }
    const randPick = (rng, arr)=> arr[Math.floor(rng()*arr.length)];
    const yen = n => "Â¥" + Number(n).toLocaleString("ja-JP");
    const sleep = ms => new Promise(res=>setTimeout(res, ms));
    const deepClone = o => JSON.parse(JSON.stringify(o));

    // Board cells
    const cells = Array.from({length:TOTAL_CELLS},(_,i)=>({index:i,type:"none",label:""}));
    cells[0] = {index:0,type:"start",label:"ã‚¹ã‚¿ãƒ¼ãƒˆ"};
    cells[TOTAL_CELLS-1] = {index:TOTAL_CELLS-1,type:"goal",label:"ã‚´ãƒ¼ãƒ«"};
    const mark = (idxs, type, label)=> idxs.forEach(i=>{cells[i].type=type; cells[i].label=label});
    mark([3,6,9,12,15,18,23,27,31,33], "event", "ã‚¤ãƒ™ãƒ³ãƒˆ");
    mark([4,10,16,22,30], "bonus", "ãƒœãƒ¼ãƒŠã‚¹");
    mark([8,14,20,26,34], "penalty", "ãƒšãƒŠãƒ«ãƒ†ã‚£");

    // IMPORTANT: define a fallback event table to avoid undefined reference errors
    const eventTable = [
      { text:"åˆä»»çµ¦ãŒå…¥ã£ãŸ +Â¥30,000", money:30000 },
      { text:"å®¶è³ƒã§ -Â¥20,000", money:-20000 },
      { text:"å‰¯æ¥­ã§ +Â¥50,000", money:50000 },
      { text:"æ•…éšœã§ -Â¥15,000", money:-15000 }
    ];

    // Achievements
    const ACHIEVEMENTS = [
      { id:"early_goal", name:"ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚´ãƒ¼ãƒ«", desc:"æ—©ãã‚´ãƒ¼ãƒ«ã™ã‚‹", type:"goal_turn", threshold:12 },
      { id:"rich_100k", name:"ãŠé‡‘æŒã¡", desc:"æ‰€æŒé‡‘ãŒÂ¥100,000ã‚’è¶…ãˆãŸ", type:"max_money", threshold:100000 },
      { id:"bonus_collector", name:"ãƒœãƒ¼ãƒŠã‚¹å¥½ã", desc:"ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¹ã«3å›æ­¢ã¾ã‚‹", type:"bonus_count", threshold:3 },
      { id:"branch_master", name:"åˆ†å²ã®é”äºº", desc:"åˆ†å²ã§æˆåŠŸã‚’2å›", type:"branch_success", threshold:2 },
      { id:"big_gain", name:"ä¸€ç™ºå¤§å½“ãŸã‚Š", desc:"1åº¦ã«å¤§ããç¨¼ã", type:"single_gain", threshold:80000 },
      { id:"winner", name:"å„ªå‹", desc:"ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã«1ä½", type:"end_rank", threshold:1 }
    ];

    // Personas (safe mutable maps)
    const DEFAULT_PERSONAS = [
      { id:"shinsotsu", displayName:"æ–°å’ã•ã‚“", color:"#ff6b6b", events: [{ text:"ç ”ä¿®ã§è©•ä¾¡ã•ã‚Œã¦æ˜‡çµ¦+Â¥15,000", money:15000 }], branchEvents: [] },
      { id:"chuto", displayName:"ä¸­é€”ã•ã‚“", color:"#4c9aff", events: [{ text:"å³æˆ¦åŠ›ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¥ã‚Š+Â¥25,000", money:25000 }], branchEvents: [] },
      { id:"shigodeki", displayName:"ã—ã”ã§ãã•ã‚“", color:"#00c853", events: [{ text:"æˆæœå ±é…¬ã§+Â¥40,000", money:40000 }], branchEvents: [] },
      { id:"shacho", displayName:"ç¤¾é•·ã•ã‚“", color:"#ff8f00", events: [{ text:"äº‹æ¥­ãŒå½“ãŸã£ã¦å¤§å„²ã‘+Â¥100,000", money:100000 }], branchEvents: [] }
    ];
    let personasStore = [];
    function initPersonas(){
      try{
        const s = localStorage.getItem("imported-personas");
        if(s){
          const d = JSON.parse(s);
          if(d && Array.isArray(d.personas)){ personasStore = d.personas; return; }
        }
      }catch(e){}
      personasStore = deepClone(DEFAULT_PERSONAS);
    }
    initPersonas();
    let PERSONAS = personasStore.map(p=>p.displayName);
    let personaEventMap = {};
    let personaBranchMap = {};
    function rebuildPersonaMaps(){
      PERSONAS = personasStore.map(p=>p.displayName);
      personaEventMap = {}; personaBranchMap = {};
      personasStore.forEach(p => { personaEventMap[p.displayName] = (p.events||[]).slice(); if(p.branchEvents) personaBranchMap[p.displayName] = p.branchEvents.slice(); });
    }
    rebuildPersonaMaps();

    // State
    let state = { started:false, turn:0, currentPlayerIndex:0, players:[], finishedCount:0, animating:false, rng:Math.random, seed:"", speed:180, overshoot:"clamp", playerSettings: [] };

    function ensurePlayerSettings(count=4){
      if(!state.playerSettings || !Array.isArray(state.playerSettings)) state.playerSettings = [];
      for(let i=0;i<count;i++){
        if(!state.playerSettings[i]) state.playerSettings[i] = { persona: PERSONAS[i] || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1}`, color: PLAYER_COLORS[i % PLAYER_COLORS.length] };
      }
      state.playerSettings.length = count;
    }

    // Rendering
    function indexToGrid(index){
      const row = Math.floor(index/BOARD_COLS); let col = index % BOARD_COLS;
      if(row % 2 === 1) col = BOARD_COLS-1-col;
      return {row, col};
    }
    function renderBoard(){
      boardEl.innerHTML = "";
      cells.forEach(cell=>{
        const div = document.createElement("div");
        div.className = "cell " + (cell.type !== "none" ? cell.type : "");
        div.dataset.index = cell.index;
        const idx = document.createElement("div"); idx.className = "idx"; idx.textContent = String(cell.index); div.appendChild(idx);
        const label = document.createElement("div"); label.textContent = cell.label || ""; div.appendChild(label);
        const g = indexToGrid(cell.index); div.style.gridRowStart = g.row+1; div.style.gridColumnStart = g.col+1;
        div.addEventListener("mouseenter", e=> showCellHover(cell, e));
        div.addEventListener("mousemove", e=> moveHover(e));
        div.addEventListener("mouseleave", hideHover);
        boardEl.appendChild(div);
      });
      state.players.forEach((pl,i)=>{
        const t = document.createElement("div"); t.className = "token"; t.id = tokenId(i); t.textContent = String(i+1); t.style.background = pl.color;
        if(pl.finished) t.classList.add("finished");
        t.style.position = "absolute"; t.style.left = "0px"; t.style.top = "0px";
        t.addEventListener("mouseenter", e=> showPlayerHover(pl, e));
        t.addEventListener("mousemove", e=> moveHover(e));
        t.addEventListener("mouseleave", hideHover);
        boardEl.appendChild(t);
      });
      placeAllTokens(); highlightActiveToken();
    }
    function tokenId(i){ return `token-${i}`; }
    function placeAllTokens(){
      const rectBoard = boardEl.getBoundingClientRect();
      const groups = new Map();
      state.players.forEach((pl,i)=> { if(!groups.has(pl.position)) groups.set(pl.position,[]); groups.get(pl.position).push(i); });
      groups.forEach((ids,pos)=>{
        const targetCell = boardEl.querySelector(`.cell[data-index="${pos}"]`);
        if(!targetCell) return;
        const rc = targetCell.getBoundingClientRect(); const cx = rc.left - rectBoard.left + rc.width/2; const cy = rc.top - rectBoard.top + rc.height/2;
        const r = Math.min(rc.width, rc.height)/3.2; const n = ids.length; const base = -90;
        ids.forEach((pi,k)=>{ const angle = base + (n===1?0:(k-(n-1)/2)*30); const rad = angle*Math.PI/180; const x = cx + r*Math.cos(rad) - 14; const y = cy + r*Math.sin(rad) - 14; const el = $("#"+tokenId(pi)); if(el) el.style.transform = `translate(${x}px, ${y}px)`; });
      });
    }
    function highlightActiveToken(){ state.players.forEach((_,i)=>{ const t = $("#"+tokenId(i)); if(!t) return; if(i===state.currentPlayerIndex) t.classList.add("active"); else t.classList.remove("active"); }); }

    // Hover tooltips for board and tokens (separate from icon tooltip)
    function showCellHover(cell,e){ const info=[]; info.push(`ãƒã‚¹ #${cell.index}`); if(cell.type) info.push(`ã‚¿ã‚¤ãƒ—: ${cell.type}`); if(cell.label) info.push(cell.label); const tt = $("#tooltip"); tt.innerHTML = info.join("<br>"); tt.style.display = "block"; tt.style.left = (e.clientX+10)+'px'; tt.style.top = (e.clientY+10)+'px'; }
    function showPlayerHover(pl,e){ const info=[]; info.push(pl.name); info.push(`æ‰€æŒé‡‘: ${yen(pl.money)}`); info.push(`ä½ç½®: ${pl.position}`); const tt = $("#tooltip"); tt.innerHTML = info.join("<br>"); tt.style.display = "block"; tt.style.left = (e.clientX+10)+'px'; tt.style.top = (e.clientY+10)+'px'; }
    function moveHover(e){ const tt = $("#tooltip"); if(tt.style.display!=="none"){ tt.style.left = (e.clientX+10)+'px'; tt.style.top = (e.clientY+10)+'px'; } }
    function hideHover(){ $("#tooltip").style.display = "none"; }

    // Sidebar players
    function moneyId(i){ return `money-${i}`; }
    function renderPlayersPanel(){
      playersPanelEl.innerHTML = "";
      state.players.forEach((pl,i)=>{
        const row = document.createElement("div"); row.className = "player-row" + (i===state.currentPlayerIndex ? " active" : "");
        const left = document.createElement("div"); const badge = document.createElement("span"); badge.className="badge"; badge.style.background = pl.color; left.appendChild(badge);
        const nm = document.createElement("span"); nm.textContent = pl.name + (pl.finished ? "ï¼ˆã‚´ãƒ¼ãƒ«ï¼‰": ""); left.appendChild(nm);
        const ach = document.createElement("div"); ach.style.marginLeft="8px"; ach.innerHTML = `<span class="ach-badge">${(pl.achievements||[]).length}</span>`; left.appendChild(ach);
        const pos = document.createElement("div"); pos.textContent = "ä½ç½®: "+pl.position;
        const money = document.createElement("div"); money.className="money"; money.id = moneyId(i); money.textContent = yen(pl.money);
        const status = document.createElement("div"); status.textContent = pl.skipTurn ? "æ¬¡ã‚¿ãƒ¼ãƒ³ä¼‘ã¿" : "";
        row.appendChild(left); row.appendChild(pos); row.appendChild(money); row.appendChild(status);
        playersPanelEl.appendChild(row);
      });
      updateKPIDisplay();
    }
    function flashMoney(i,delta){ const el = $("#"+moneyId(i)); if(!el) return; const cls = delta>=0?"flash-plus":"flash-minus"; el.classList.add(cls); setTimeout(()=>el.classList.remove(cls),400); }

    // Log
    function pushLog(text, kind){ const p = document.createElement("p"); p.textContent = text; if(kind) p.classList.add(kind); logEl.appendChild(p); logEl.scrollTop = logEl.scrollHeight; }

    // Achievements helpers
    function awardAchievement(playerIndex, achId){
      const p = state.players[playerIndex]; if(!p) return;
      p.achievements = p.achievements || [];
      if(p.achievements.find(a=>a.id===achId)) return;
      const def = ACHIEVEMENTS.find(a=>a.id===achId); if(!def) return;
      p.achievements.push({ id:def.id, name:def.name, desc:def.desc, awardedAt:new Date().toISOString() });
      pushLog(`${p.name} ãŒå®Ÿç¸¾ã‚’ç²å¾—: ${def.name}`, "ok"); renderPlayersPanel();
    }
    function evaluatePlayerAchievements(i){ const p = state.players[i]; if(!p) return; if(p.turnsToGoal && p.turnsToGoal <= 12) awardAchievement(i, "early_goal"); if((p.maxMoneyReached||0) >= 100000) awardAchievement(i, "rich_100k"); if((p.bonusCount||0) >= 3) awardAchievement(i, "bonus_collector"); if((p.branchSuccessCount||0) >= 2) awardAchievement(i, "branch_master"); if((p.highestSingleGain||0) >= 80000) awardAchievement(i, "big_gain"); }

    // Branch modal (simple)
    function showBranchModal(branchEv, playerIndex){
      $("#modal-title").textContent = "åˆ†å²ã‚¤ãƒ™ãƒ³ãƒˆ"; $("#modal-text").textContent = branchEv.text; $("#modal-sub").textContent = `ã‚ãªãŸ: ${state.players[playerIndex].name}`;
      const actions = $("#modal-actions"); actions.innerHTML = "";
      branchEv.choices.forEach(choice=>{ const b = document.createElement("button"); b.textContent = choice.label; b.onclick = async ()=>{
        const prob = typeof choice.probGood === "number" ? choice.probGood : 1.0; const success = state.rng() < prob; const pl = state.players[playerIndex]; const res = success ? (choice.success||{}) : (choice.failure||{});
        if(typeof res.money === "number"){ const delta = res.money; pl.money += delta; KPIs.budgetRemaining -= Math.abs(delta); KPIs.impact += delta; if(delta > (pl.highestSingleGain||0)) pl.highestSingleGain = delta; if(pl.money > (pl.maxMoneyReached||0)) pl.maxMoneyReached = pl.money; flashMoney(playerIndex, delta); }
        if(success) pl.branchSuccessCount = (pl.branchSuccessCount||0)+1;
        KPIs.clientSatisfaction = Math.max(0, Math.min(100, KPIs.clientSatisfaction + (success?5:-4))); KPIs.progress = Math.max(0, Math.min(100, KPIs.progress + (success?3:-1)));
        updateKPIDisplay(); pushLog(`${pl.name}: ${(res.text|| (success?"æˆåŠŸ":"å¤±æ•—"))} ${res.money?yen(res.money):""}`, success?"ok":"bad");
        if(typeof res.move === "number" && res.move !== 0){ if(res.move>0) await animateMove(playerIndex, res.move); else { pl.position = Math.max(0, pl.position + res.move); placeAllTokens(); resolveCell(playerIndex, pl.position); } } else renderPlayersPanel();
        evaluatePlayerAchievements(playerIndex); $("#modal").close();
      }; actions.appendChild(b); });
      const cancel = document.createElement("button"); cancel.textContent="ã‚„ã‚ã‚‹"; cancel.onclick = ()=> $("#modal").close(); actions.appendChild(cancel);
      $("#modal").showModal();
    }

    // resolveCell (use eventTable fallback to avoid undefined)
    function resolveCell(playerIndex, index){
      const pl = state.players[playerIndex]; const cell = cells[index]; if(!cell||!pl) return;
      switch(cell.type){
        case "start": pushLog(`${pl.name}: ã‚¹ã‚¿ãƒ¼ãƒˆï¼`, "ok"); break;
        case "goal":
          if(!pl.finished){ pl.finished = true; state.finishedCount += 1; $("#"+tokenId(playerIndex))?.classList.add("finished"); pl.turnsToGoal = state.turn; pushLog(`${pl.name}: ã‚´ãƒ¼ãƒ«ï¼`); $("#modal-title").textContent="ã‚´ãƒ¼ãƒ«"; $("#modal-text").textContent = `${pl.name} ãŒã‚´ãƒ¼ãƒ«ï¼`; $("#modal-sub").textContent = `æ®‹é«˜: ${yen(pl.money)}`; $("#modal").showModal(); evaluatePlayerAchievements(playerIndex); }
          break;
        case "bonus":{
          const amount = randPick(state.rng, [5000,8000,10000,15000,20000]); pl.money += amount; KPIs.budgetRemaining -= amount; KPIs.impact += amount;
          pl.bonusCount = (pl.bonusCount||0)+1; if(amount > (pl.highestSingleGain||0)) pl.highestSingleGain = amount; if(pl.money > (pl.maxMoneyReached||0)) pl.maxMoneyReached = pl.money;
          kpiProgressInc(5); KPIs.clientSatisfaction = Math.min(100, KPIs.clientSatisfaction + 2); flashMoney(playerIndex, amount);
          pushLog(`${pl.name}: ãƒœãƒ¼ãƒŠã‚¹ ${yen(amount)} ç²å¾—ï¼ˆæ®‹é«˜: ${yen(pl.money)}ï¼‰`, "ok"); evaluatePlayerAchievements(playerIndex);
          break;
        }
        case "penalty":{
          const amount = randPick(state.rng, [5000,8000,10000,15000,20000]); pl.money -= amount; KPIs.budgetRemaining -= amount; KPIs.impact -= amount;
          KPIs.clientSatisfaction = Math.max(0, KPIs.clientSatisfaction - 3); kpiProgressInc(-1); flashMoney(playerIndex, -amount);
          pushLog(`${pl.name}: ãƒšãƒŠãƒ«ãƒ†ã‚£ ${yen(amount)}ï¼ˆæ®‹é«˜: ${yen(pl.money)}ï¼‰`, "bad"); break;
        }
        case "event":{
          if(state.rng() < BRANCH_CHANCE){
            const pb = personaBranchMap[pl.name]; if(pb && pb.length>0){ const be = randPick(state.rng, pb); showBranchModal(be, playerIndex); return; }
            const defaultBranch = { text:"åˆ†å²ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰", choices:[ { label:"æŒ‘æˆ¦ã™ã‚‹", probGood:0.6, success:{money:20000,move:1,text:"æˆåŠŸï¼"}, failure:{money:-10000,move:0,text:"å¤±æ•—â€¦"} }, { label:"ã‚„ã‚ã‚‹", probGood:1.0, success:{money:0,move:0,text:"ä½•ã‚‚èµ·ããªã„"}, failure:{money:0,move:0,text:""} } ]};
            showBranchModal(defaultBranch, playerIndex); return;
          }
          const personaEvents = personaEventMap[pl.name];
          if(personaEvents && personaEvents.length > 0 && state.rng() < 0.7){
            const ev = randPick(state.rng, personaEvents); pl.money += ev.money; KPIs.budgetRemaining -= ev.money; KPIs.impact += ev.money;
            if(ev.money > (pl.highestSingleGain||0)) pl.highestSingleGain = ev.money; if(pl.money > (pl.maxMoneyReached||0)) pl.maxMoneyReached = pl.money;
            if(state.rng() < 0.10) { pl.skipTurn = true; pushLog(`${pl.name}: æ¬¡ã¯ã‚¹ã‚­ãƒƒãƒ—`); }
            kpiProgressInc(2); KPIs.clientSatisfaction = Math.min(100, KPIs.clientSatisfaction + (ev.money>0?2:-2)); flashMoney(playerIndex, ev.money);
            pushLog(`${pl.name}: ${ev.text}ï¼ˆæ®‹é«˜: ${yen(pl.money)}ï¼‰`, ev.money>=0?"ok":"bad"); evaluatePlayerAchievements(playerIndex); renderPlayersPanel(); $("#modal-title").textContent="ã‚¤ãƒ™ãƒ³ãƒˆ"; $("#modal-text").textContent = ev.text; $("#modal-sub").textContent = `${pl.name} / æ®‹é«˜: ${yen(pl.money)}`; $("#modal").showModal(); return;
          }
          // fallback event table (safe)
          const ev = randPick(state.rng, eventTable);
          pl.money += ev.money; KPIs.budgetRemaining -= ev.money; KPIs.impact += ev.money;
          if(ev.money > (pl.highestSingleGain||0)) pl.highestSingleGain = ev.money; if(pl.money > (pl.maxMoneyReached||0)) pl.maxMoneyReached = pl.money;
          if(state.rng() < 0.10) { pl.skipTurn = true; pushLog(`${pl.name}: æ¬¡ã¯ã‚¹ã‚­ãƒƒãƒ—`); }
          kpiProgressInc(1); KPIs.clientSatisfaction = Math.min(100, KPIs.clientSatisfaction + (ev.money>0?1:-1)); flashMoney(playerIndex, ev.money);
          pushLog(`${pl.name}: ${ev.text}ï¼ˆæ®‹é«˜: ${yen(pl.money)}ï¼‰`, ev.money>=0?"ok":"bad"); $("#modal-title").textContent="ã‚¤ãƒ™ãƒ³ãƒˆ"; $("#modal-text").textContent = ev.text; $("#modal-sub").textContent = `${pl.name} / æ®‹é«˜: ${yen(pl.money)}`; $("#modal").showModal(); evaluatePlayerAchievements(playerIndex);
          break;
        }
      }
      renderPlayersPanel();
    }

    function kpiProgressInc(n){ KPIs.progress = Math.max(0, Math.min(100, KPIs.progress + n)); updateKPIDisplay(); }

    // Dice & move
    function rollDice(){ const n = Math.floor(state.rng()*6)+1; diceEl.textContent = n; return n; }
    async function animateMove(playerIndex, steps){
      const pl = state.players[playerIndex]; if(!pl || pl.finished) return;
      state.animating = true; updateRollState();
      const delay = Number(speedInput.value || state.speed);
      let pos = pl.position; let remain = steps;
      while(remain>0){
        let next = pos + 1;
        if(next >= TOTAL_CELLS-1){
          if(state.overshoot === "clamp"){ next = TOTAL_CELLS-1; pos = next; pl.position = pos; placeAllTokens(); await sleep(delay); break; }
          else {
            const extra = remain - 1 - ((TOTAL_CELLS-1) - pos - 1);
            pos = TOTAL_CELLS-1; pl.position = pos; placeAllTokens(); await sleep(delay);
            for(let b=0;b<extra;b++){ pos -= 1; pl.position = pos; placeAllTokens(); await sleep(delay); }
            remain = 0; break;
          }
        }
        pos = next; pl.position = pos; placeAllTokens(); await sleep(delay); remain--;
      }
      resolveCell(playerIndex, pl.position);
      state.animating = false; updateRollState();
    }

    function nextPlayerTurn(){ const total = state.players.length; let i = state.currentPlayerIndex; for(let c=0;c<total;c++){ i=(i+1)%total; const p = state.players[i]; if(!p.finished){ state.currentPlayerIndex = i; break; } } highlightActiveToken(); renderPlayersPanel(); statCurrentEl.textContent = state.players[state.currentPlayerIndex].name; }
    const isGameFinished = ()=> state.finishedCount === state.players.length;

    // Snapshot / restore
    const SAVE_KEY = "life-game-save-v17";
    function snapshot(){ return JSON.stringify({ started:state.started, turn:state.turn, currentPlayerIndex:state.currentPlayerIndex, finishedCount:state.finishedCount, players:state.players, seed:state.seed, overshoot:state.overshoot, speed:Number(speedInput.value||state.speed), playerSettings:state.playerSettings, personas:personasStore, scenarioId: currentScenario?.id||null, KPIs }); }
    function restore(json){ try{ const d = JSON.parse(json); state.started = d.started; state.turn = d.turn; state.currentPlayerIndex = d.currentPlayerIndex; state.finishedCount = d.finishedCount; state.players = d.players || []; state.seed = d.seed||""; state.overshoot = d.overshoot||"clamp"; state.rng = createRNG(state.seed||""); speedInput.value = String(d.speed||180); overshootSel.value = state.overshoot; rngSeedInput.value = state.seed; state.playerSettings = d.playerSettings || []; if(Array.isArray(d.personas)) { personasStore = d.personas; rebuildPersonaMaps(); } if(d.scenarioId) loadScenarioToState(d.scenarioId); if(d.KPIs) { KPIs = d.KPIs; updateKPIDisplay(); } renderBoard(); renderPlayersPanel(); statTurnEl.textContent = String(state.turn); statCurrentEl.textContent = state.players[state.currentPlayerIndex]?.name || "-"; pushLog("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚", "ok"); }catch(e){ console.error(e); alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"); } }
    $("#btn-save-slot").addEventListener("click", ()=> { const slot = saveSlotSel.value; try{ localStorage.setItem("life-game-slot-"+slot, snapshot()); pushLog(`ã‚¹ãƒ­ãƒƒãƒˆ ${slot} ã«ä¿å­˜ã—ã¾ã—ãŸ`); }catch(e){ alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ"); }});
    $("#btn-load-slot").addEventListener("click", ()=> { const slot = saveSlotSel.value; const s = localStorage.getItem("life-game-slot-"+slot); if(!s) return alert("ã‚¹ãƒ­ãƒƒãƒˆã«ä¿å­˜ãŒã‚ã‚Šã¾ã›ã‚“"); restore(s); });

    // Persona import wiring (simple)
    const filePersonas = document.createElement('input'); filePersonas.type='file'; filePersonas.accept='application/json'; filePersonas.style.display='none'; document.body.appendChild(filePersonas);
    filePersonas.addEventListener('change', async e => {
      const f = e.target.files?.[0]; if(!f) return;
      try{ const txt = await f.text(); const json = JSON.parse(txt); if(!json || !Array.isArray(json.personas)) throw new Error("personas é…åˆ—ãŒã‚ã‚Šã¾ã›ã‚“"); personasStore = json.personas; localStorage.setItem("imported-personas", JSON.stringify({ personas: personasStore })); rebuildPersonaMaps(); pushLog("ãƒšãƒ«ã‚½ãƒŠã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ", "ok"); }catch(err){ console.error(err); alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"); } finally { filePersonas.value = ""; }
    });

    // Settings (simple)
    function buildSettingsForm(){ const count = Number(playersCountSel.value) || 4; ensurePlayerSettings(count); let html = ''; for(let i=0;i<count;i++){ const s = state.playerSettings[i] || { persona: PERSONAS[i]||`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1}`, color:PLAYER_COLORS[i%PLAYER_COLORS.length] }; html += `<div style="display:flex;gap:8px;align-items:center"><div style="width:24px">${i+1}</div><select data-idx="${i}">` + PERSONAS.map(p=>`<option${p===s.persona?' selected':''}>${p}</option>`).join('') + `</select><input type="color" data-color-idx="${i}" value="${s.color}" /></div>`; } alert('è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¯ç°¡æ˜“ã§ã™ã€‚ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®šã‚’ä¿å­˜ã—ã¾ã™ã€‚'); }
    $("#btn-manage-scenarios").addEventListener('click', ()=> { renderBoard(); });

    // Start / Reset / Roll wiring
    $("#btn-start").addEventListener("click", ()=>{
      try{
        if(state.started) return;
        const count = Number(playersCountSel.value) || 4;
        const initial = Number(initialMoneyInput.value) || 20000;
        const seed = (rngSeedInput.value||"").trim(); state.seed = seed; state.rng = createRNG(seed);
        ensurePlayerSettings(count);
        if(!currentScenario) loadScenarioToState(scenarioSelect.value || (scenarios[0] && scenarios[0].id));
        state.players = Array.from({length:count},(_,i)=>({ name: state.playerSettings[i]?.persona || PERSONAS[i] || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1}`, color: state.playerSettings[i]?.color || PLAYER_COLORS[i%PLAYER_COLORS.length], position:0, money:initial, finished:false, skipTurn:false, achievements:[], bonusCount:0, branchSuccessCount:0, maxMoneyReached:initial, highestSingleGain:0, turnsToGoal:null }));
        state.started = true; state.turn = 1; state.currentPlayerIndex = 0; state.finishedCount = 0; state.overshoot = overshootSel.value; state.speed = Number(speedInput.value||180);
        pushLog(`ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ã‚±ãƒ¼ã‚¹: ${currentScenario.title} | åˆæœŸè³‡é‡‘: ${yen(initial)} | ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°: ${count}`, "ok");
        renderBoard(); renderPlayersPanel(); statTurnEl.textContent=String(state.turn); statCurrentEl.textContent=state.players[state.currentPlayerIndex].name; btnRoll.disabled = false; diceEl.textContent='-';
      }catch(err){ console.error('start error', err); alert('é–‹å§‹ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'); }
    });

    $("#btn-reset").addEventListener("click", ()=> { Object.assign(state, { started:false, turn:0, currentPlayerIndex:0, players:[], finishedCount:0, animating:false }); btnRoll.disabled = true; logEl.innerHTML=''; statTurnEl.textContent='0'; statCurrentEl.textContent='-'; diceEl.textContent='-'; renderBoard(); playersPanelEl.innerHTML=''; pushLog('ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ'); });

    $("#btn-roll").addEventListener("click", async ()=>{
      if(!state.started || state.animating) return;
      const pl = state.players[state.currentPlayerIndex]; if(!pl || pl.finished){ nextPlayerTurn(); return; }
      if(pl.skipTurn){ pushLog(`${pl.name}: ã‚¿ãƒ¼ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™`); pl.skipTurn=false; state.turn+=1; statTurnEl.textContent=String(state.turn); nextPlayerTurn(); return; }
      const d = rollDice(); pushLog(`${pl.name}: ã‚µã‚¤ã‚³ãƒ­ â†’ ${d}`);
      const remaining = (TOTAL_CELLS-1) - pl.position; const steps = state.overshoot === "clamp" ? Math.min(d, remaining) : d;
      await animateMove(state.currentPlayerIndex, steps);
      if(currentScenario && state.turn >= currentScenario.deadlineTurns){ KPIs.clientSatisfaction = Math.max(0, KPIs.clientSatisfaction - 10); updateKPIDisplay(); pushLog('æœŸé™ãŒè¿‘ã¥ã„ã¦ã„ã¾ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæº€è¶³åº¦ãŒä½ä¸‹ã—ã¾ã—ãŸã€‚','bad'); }
      state.turn += 1; statTurnEl.textContent = String(state.turn);
      if(isGameFinished()){ pushLog('å…¨å“¡ã‚´ãƒ¼ãƒ«ï¼ã‚²ãƒ¼ãƒ çµ‚äº†ï¼'); btnRoll.disabled = true; setTimeout(()=>{ evaluateEndAchievements(); openResult(); }, 200); return; }
      nextPlayerTurn(); btnRoll.disabled = false;
    });

    function openResult(){ evaluateEndAchievements(); const rows = state.players.map((p,i)=>({i,name:p.name,money:p.money})).sort((a,b)=> b.money-a.money); let html = '<table><thead><tr><th>é †ä½</th><th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th><th>æ‰€æŒé‡‘</th></tr></thead><tbody>'; rows.forEach((r,idx)=> html += `<tr><td>${idx+1}</td><td>${r.name}</td><td>${yen(r.money)}</td></tr>`); html += '</tbody></table>'; $("#result-body").innerHTML = html; $("#result").showModal(); }
    $("#result-close").addEventListener("click", ()=> $("#result").close());

    // Keyboard shortcuts
    window.addEventListener("keydown", e=>{
      const openDialog = document.querySelector('dialog.modal[open]');
      if(openDialog && !(openDialog.id === "modal" && (e.key.toLowerCase()==='h'))) return;
      if(e.code === "Space" || e.key === "Enter"){ e.preventDefault(); $("#btn-roll").click(); }
      if(e.key.toLowerCase()==='r') $("#btn-reset").click();
      if(e.key.toLowerCase()==='s') $("#btn-save-slot").click();
      if(e.key.toLowerCase()==='l') $("#btn-load-slot").click();
      if(e.key.toLowerCase()==='z'){ if(e.shiftKey) { setCellSize(Math.max(44, getCellSize() - 8)); } else setCellSize(getCellSize() + 8); }
      if(e.key.toLowerCase()==='f') fitBoard();
    });

    // Zoom helpers
    function getCellSize(){ const v = getComputedStyle(document.documentElement).getPropertyValue('--cell-size') || '72px'; return parseInt(v); }
    function setCellSize(px){ document.documentElement.style.setProperty('--cell-size', px+'px'); document.documentElement.style.setProperty('--board-max-width', `calc(${px}px * var(--board-cols) + 32px)`); placeAllTokens(); }
    function zoomIn(){ setCellSize(getCellSize()+parseInt(getComputedStyle(document.documentElement).getPropertyValue('--zoom-step'))); }
    function zoomOut(){ setCellSize(Math.max(44, getCellSize()-parseInt(getComputedStyle(document.documentElement).getPropertyValue('--zoom-step')))); }
    function fitBoard(){ const toolbarRect = document.querySelector('.appbar').getBoundingClientRect(); const viewportH = window.innerHeight; const availableH = viewportH - toolbarRect.height - 48; const maxCellH = Math.floor((availableH - 16) / BOARD_ROWS); const current = getCellSize(); const newSize = Math.max(44, Math.min(current, maxCellH)); setCellSize(newSize); }
    $("#btn-zoom-in").addEventListener("click", zoomIn);
    $("#btn-zoom-out").addEventListener("click", zoomOut);
    $("#btn-fit").addEventListener("click", fitBoard);

    // Ensure roll-button state is recomputed when dialogs open/close
    function updateRollState(){ $("#btn-roll").disabled = !state.started || state.animating; }
    document.querySelectorAll('dialog.modal').forEach(d => { d.addEventListener('close', updateRollState); d.addEventListener('cancel', updateRollState); });

    // initial render
    ensurePlayerSettings(Number(playersCountSel.value) || 4);
    renderBoard();
    setTimeout(()=>{ fitBoard(); }, 80);
    window.addEventListener('resize', ()=> placeAllTokens());

    // expose debug
    window._life = { state, scenarios, KPIs, loadScenarioToState, snapshot, restore };

  })();
  </script>
</body>
</html>
