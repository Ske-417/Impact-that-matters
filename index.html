/* Replace startGame() and updateRollState() in your <script> with the following */

function updateRollState(){
  try{
    if(!btnRoll) return;
    // enable only when game started and not animating
    btnRoll.disabled = !(state.started && !state.animating);
    // ensure button is focusable when enabled
    if(!btnRoll.disabled) btnRoll.removeAttribute('aria-disabled');
    else btnRoll.setAttribute('aria-disabled','true');
  }catch(e){
    console.error("updateRollState error:", e);
    if(btnRoll) btnRoll.disabled = true;
  }
}

function startGame(){
  if(state.started) return;
  try{
    const count = Math.max(1, parseInt(playersCountSel?.value || "2"));
    const initialLearning = 50;
    const initialMental = 50;
    const initialRating = 50;
    const initialResp = 0;
    const names = getPlayerNames();
    state.players = [];
    for(let i=0;i<count;i++){
      state.players.push({
        name: names[i] || `プレイヤー${i+1}`,
        color: PLAYER_COLORS[i % PLAYER_COLORS.length],
        position: 0,
        learning: initialLearning,
        mental: initialMental,
        rating: initialRating,
        responsibility: initialResp,
        achievements: [],
        finished: false,
        skipTurn: false
      });
    }
    state.started = true;
    state.turn = 1;
    state.currentPlayerIndex = 0;
    state.finishedCount = 0;
    state.rng = Math.random;
    renderBoard();
    renderPlayersPanel();
    statTurnEl.textContent = String(state.turn);
    statCurrentEl.textContent = state.players[state.currentPlayerIndex].name;
    pushLog("ゲームを開始しました", "ok");
    // Force enable dice button as a safety net
    if(btnRoll) { btnRoll.disabled = false; btnRoll.removeAttribute('aria-disabled'); }
    updateRollState();
    if(btnStart) btnStart.disabled = true;
  }catch(e){
    console.error("startGame error:", e);
    // If start failed, ensure UI reflects not-started state
    state.started = false;
    updateRollState();
    if(btnStart) btnStart.disabled = false;
    pushLog("ゲーム開始に失敗しました（コンソール確認）", "bad");
  }
}
